# ç¬¬ä¸€é˜¶æ®µå®Œæˆï¼šTask<T> åç¨‹åŸºç¡€ç±»å‹

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ ¸å¿ƒå®ç° (`include/zlcoro/core/task.hpp`)

å®ç°äº†å®Œæ•´çš„ Task<T> åç¨‹ç±»å‹ï¼ŒåŒ…æ‹¬ï¼š

#### **Promise ç±»å‹**
- `TaskPromiseBase`: åŸºç±»ï¼Œå¤„ç†åç¨‹çš„æŒ‚èµ·/æ¢å¤é€»è¾‘
- `TaskPromise<T>`: å¤„ç†æœ‰è¿”å›å€¼çš„åç¨‹
- `TaskPromise<void>`: å¤„ç† void è¿”å›çš„åç¨‹  
- `TaskPromise<T&>`: å¤„ç†å¼•ç”¨è¿”å›çš„åç¨‹

#### **æ ¸å¿ƒæœºåˆ¶**
- âœ… **æƒ°æ€§æ±‚å€¼**: åç¨‹åœ¨åˆ›å»ºæ—¶ä¸ç«‹å³æ‰§è¡Œ(`initial_suspend` è¿”å› `suspend_always`)
- âœ… **åç¨‹é“¾**: æ”¯æŒ `co_await` å¦ä¸€ä¸ª Taskï¼Œè‡ªåŠ¨ç®¡ç†å»¶ç»­(continuation)
- âœ… **å¼‚å¸¸å¤„ç†**: å®Œæ•´çš„å¼‚å¸¸æ•è·å’Œä¼ æ’­æœºåˆ¶
- âœ… **ç§»åŠ¨è¯­ä¹‰**: Task åªèƒ½ç§»åŠ¨ï¼Œä¸å¯å¤åˆ¶ï¼Œæ­£ç¡®ç®¡ç†åç¨‹å¥æŸ„çš„æ‰€æœ‰æƒ
- âœ… **å¤šç§è¿”å›ç±»å‹**: æ”¯æŒå€¼ç±»å‹ã€voidã€å¼•ç”¨ç±»å‹

#### **API æ¥å£**
- `co_await task`: ç­‰å¾…å¦ä¸€ä¸ªåç¨‹å®Œæˆ
- `task.sync_wait()`: åŒæ­¥é˜»å¡ç­‰å¾…åç¨‹å®Œæˆï¼ˆç”¨äºæµ‹è¯•å’Œè¾¹ç•Œåœºæ™¯ï¼‰

### 2. å•å…ƒæµ‹è¯• (`tests/core/task_test.cpp`)

åˆ›å»ºäº† **15 ä¸ªå•å…ƒæµ‹è¯•**ï¼Œè¦†ç›–ï¼š
- åŸºæœ¬åŠŸèƒ½ï¼šint/void/string/å¼•ç”¨è¿”å›
- åç¨‹é“¾ï¼šå•å±‚ã€å¤šå±‚ã€å¤šä¸ª await
- å¼‚å¸¸å¤„ç†ï¼šæŠ›å‡ºã€ä¼ æ’­ã€æ•è·
- ç§»åŠ¨è¯­ä¹‰ï¼šç§»åŠ¨æ„é€ ã€ç§»åŠ¨èµ‹å€¼
- å¤æ‚åœºæ™¯ï¼šå¤æ‚å¯¹è±¡ã€æ¡ä»¶åˆ†æ”¯ã€é€’å½’åç¨‹

**æµ‹è¯•ç»“æœ**: âœ… 15/15 é€šè¿‡

### 3. ç¤ºä¾‹ç¨‹åº (`examples/01_basic_task.cpp`)

åˆ›å»ºäº† **7 ä¸ªç¤ºä¾‹**ï¼Œå±•ç¤ºï¼š
1. æœ€ç®€å•çš„åç¨‹
2. void è¿”å›ç±»å‹
3. åç¨‹é“¾å¼è°ƒç”¨
4. å¤šä¸ª co_await
5. å¼‚å¸¸å¤„ç†
6. å¤æ‚å·¥ä½œæµ
7. é€’å½’åç¨‹ï¼ˆæ–æ³¢é‚£å¥‘ï¼‰

**è¿è¡Œç»“æœ**: âœ… æ‰€æœ‰ç¤ºä¾‹æ­£å¸¸è¿è¡Œ

### 4. æ„å»ºç³»ç»Ÿ

- âœ… CMake é…ç½®æ­£ç¡®
- âœ… ä½¿ç”¨ g++ 11.4 (æ”¯æŒ C++20 åç¨‹)
- âœ… é›†æˆ Google Test
- âœ… æ”¯æŒ `make` å’Œ `ctest`


### åç¨‹çš„ä¸‰ä¸ªæ ¸å¿ƒæ¦‚å¿µ

#### 1. **Promise Type** (æ‰¿è¯ºç±»å‹)
Promise å®šä¹‰äº†åç¨‹çš„è¡Œä¸ºï¼š
- `get_return_object()`: åˆ›å»º Task å¯¹è±¡
- `initial_suspend()`: åç¨‹å¯åŠ¨æ—¶çš„è¡Œä¸º
- `final_suspend()`: åç¨‹ç»“æŸæ—¶çš„è¡Œä¸º
- `return_value()` / `return_void()`: å¦‚ä½•å­˜å‚¨è¿”å›å€¼
- `unhandled_exception()`: å¦‚ä½•å¤„ç†å¼‚å¸¸

#### 2. **Awaiter** (ç­‰å¾…å™¨)
Awaiter å®šä¹‰äº† `co_await` çš„è¡Œä¸ºï¼š
- `await_ready()`: æ˜¯å¦éœ€è¦æŒ‚èµ·
- `await_suspend()`: æŒ‚èµ·æ—¶åšä»€ä¹ˆï¼ˆé€šå¸¸æ˜¯è°ƒåº¦ï¼‰
- `await_resume()`: æ¢å¤æ—¶è¿”å›ä»€ä¹ˆï¼ˆé€šå¸¸æ˜¯ç»“æœï¼‰

#### 3. **Coroutine Handle** (åç¨‹å¥æŸ„)
åç¨‹å¥æŸ„æ˜¯å¯¹åç¨‹çŠ¶æ€çš„å¼•ç”¨ï¼š
- `handle.resume()`: æ¢å¤åç¨‹æ‰§è¡Œ
- `handle.done()`: æ£€æŸ¥åç¨‹æ˜¯å¦å®Œæˆ
- `handle.destroy()`: é”€æ¯åç¨‹
- `handle.promise()`: è·å– Promise å¯¹è±¡

### åç¨‹æ‰§è¡Œæµç¨‹ç¤ºä¾‹

```cpp
Task<int> inner() {
    co_return 10;  // 1. è°ƒç”¨ promise.return_value(10)
}                   // 2. è°ƒç”¨ final_suspend()ï¼Œè®¾ç½®å»¶ç»­

Task<int> outer() {
    int x = co_await inner();  // 3. è°ƒç”¨ inner çš„ Awaiter
                                // 4. await_suspend è®¾ç½®å»¶ç»­
                                // 5. æ¢å¤ inner åç¨‹
                                // 6. inner å®Œæˆåæ¢å¤ outer
                                // 7. await_resume è¿”å› 10
    co_return x * 2;           // 8. è¿”å› 20
}
```

---

## ğŸ¯ å½“å‰é¡¹ç›®çŠ¶æ€

```
ZLCoro/
â”œâ”€â”€ include/zlcoro/core/
â”‚   â”œâ”€â”€ task.hpp          âœ… å®Œæ•´å®ç° 
â”‚   â””â”€â”€ generator.hpp     âœ… å®Œæ•´å®ç°
â”œâ”€â”€ tests/core/
â”‚   â”œâ”€â”€ task_test.cpp     âœ… 15 ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡
â”‚   â””â”€â”€ generator_test.cpp âœ… 16 ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡
â”œâ”€â”€ examples/
â”‚   â”œâ”€â”€ 01_basic_task.cpp âœ… 7 ä¸ªç¤ºä¾‹æ­£å¸¸è¿è¡Œ
â”‚   â””â”€â”€ 02_generator_example.cpp âœ… 10 ä¸ªç¤ºä¾‹æ­£å¸¸è¿è¡Œ
â””â”€â”€ build/                âœ… ç¼–è¯‘æˆåŠŸ
```

---

# ç¬¬äºŒé˜¶æ®µå®Œæˆï¼šGenerator<T> ç”Ÿæˆå™¨åç¨‹

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ ¸å¿ƒå®ç° (`include/zlcoro/core/generator.hpp`)

å®ç°äº†å®Œæ•´çš„ Generator<T> åç¨‹ç±»å‹ï¼ŒåŒ…æ‹¬ï¼š

#### **Promise ç±»å‹**
- `promise_type`: å®šä¹‰ Generator çš„åç¨‹è¡Œä¸º
- `yield_value()`: å¤„ç† `co_yield` è¡¨è¾¾å¼ï¼Œå­˜å‚¨ç”Ÿæˆçš„å€¼
- `return_void()`: åªæ”¯æŒ `co_return` æ— è¿”å›å€¼

#### **è¿­ä»£å™¨å®ç°**
- `Iterator`: æ ‡å‡†çš„è¾“å…¥è¿­ä»£å™¨ (input_iterator)
- æ”¯æŒ `operator++`, `operator*`, `operator==`
- å®ç° range-based for å¾ªç¯æ”¯æŒ

#### **æ ¸å¿ƒæœºåˆ¶**
- âœ… **æƒ°æ€§æ±‚å€¼**: åˆ›å»ºæ—¶ä¸æ‰§è¡Œï¼Œè°ƒç”¨ `begin()` æ‰å¼€å§‹ç”Ÿæˆ
- âœ… **co_yield æ”¯æŒ**: å¯ä»¥å¤šæ¬¡äº§ç”Ÿå€¼ï¼Œæ¯æ¬¡æŒ‚èµ·åç¨‹
- âœ… **è¿­ä»£å™¨æ¥å£**: å®Œæ•´çš„ begin()/end() æ”¯æŒ
- âœ… **å¼‚å¸¸å¤„ç†**: æ•è·å’Œä¼ æ’­ç”Ÿæˆè¿‡ç¨‹ä¸­çš„å¼‚å¸¸
- âœ… **ç§»åŠ¨è¯­ä¹‰**: åªèƒ½ç§»åŠ¨ï¼Œä¸å¯å¤åˆ¶

### 2. å•å…ƒæµ‹è¯• (`tests/core/generator_test.cpp`)

åˆ›å»ºäº† **16 ä¸ªå•å…ƒæµ‹è¯•**ï¼Œè¦†ç›–ï¼š
- **åŸºç¡€åŠŸèƒ½**: ç®€å•åºåˆ—ã€rangeã€ç©ºç”Ÿæˆå™¨ã€å•ä¸ªå€¼
- **ä¸åŒç±»å‹**: å­—ç¬¦ä¸²ã€è‡ªå®šä¹‰ç±»å‹
- **æƒ°æ€§æ±‚å€¼**: éªŒè¯æŒ‰éœ€ç”Ÿæˆã€æå‰é€€å‡º
- **å¤æ‚åœºæ™¯**: æ–æ³¢é‚£å¥‘ã€æ¡ä»¶è¿‡æ»¤ã€åµŒå¥—å¾ªç¯
- **å¼‚å¸¸å¤„ç†**: ç”Ÿæˆä¸­æŠ›å¼‚å¸¸ã€é¦–æ¬¡ yield å‰æŠ›å¼‚å¸¸
- **ç§»åŠ¨è¯­ä¹‰**: ç§»åŠ¨æ„é€ ã€ç§»åŠ¨èµ‹å€¼
- **è¿­ä»£å™¨**: æ‰‹åŠ¨è¿­ä»£å™¨æ“ä½œ

**æµ‹è¯•ç»“æœ**: âœ… 16/16 é€šè¿‡

### 3. ç¤ºä¾‹ç¨‹åº (`examples/02_generator_example.cpp`)

åˆ›å»ºäº† **10 ä¸ªç¤ºä¾‹**ï¼Œå±•ç¤ºï¼š
1. ç®€å•çš„ Generator
2. Range å‡½æ•° (0 åˆ° n)
3. æ–æ³¢é‚£å¥‘æ•°åˆ—
4. æ¡ä»¶è¿‡æ»¤ (å¶æ•°)
5. æƒ°æ€§æ±‚å€¼ (æ— é™åºåˆ—)
6. å­—ç¬¦ä¸²ç”Ÿæˆå™¨
7. ç”Ÿæˆåæ ‡å¯¹
8. æ”¶é›†æ•°æ®åˆ°å®¹å™¨
9. æ¨¡æ‹Ÿè¯»å–æ–‡ä»¶è¡Œ
10. è´¨æ•°ç”Ÿæˆå™¨

**è¿è¡Œç»“æœ**: âœ… æ‰€æœ‰ç¤ºä¾‹æ­£å¸¸è¿è¡Œ

---

## ğŸ’¡ Generator vs Task å¯¹æ¯”

| ç‰¹æ€§ | Task<T> | Generator<T> |
|------|---------|--------------|
| **è¿”å›æ–¹å¼** | `co_return` ä¸€æ¬¡ | `co_yield` å¤šæ¬¡ |
| **æ‰§è¡Œæ¨¡å¼** | æ‰§è¡Œåˆ°ç»“æŸ | æƒ°æ€§ç”Ÿæˆï¼Œå¯æå‰ç»ˆæ­¢ |
| **ä½¿ç”¨åœºæ™¯** | å¼‚æ­¥ä»»åŠ¡ | åºåˆ—ç”Ÿæˆ |
| **è¿­ä»£** | ä¸æ”¯æŒ | æ”¯æŒ range-based for |
| **æŒ‚èµ·ç‚¹** | `co_await` | `co_yield` |

---

## ğŸš€ ä¸‹ä¸€æ­¥è®¡åˆ’

### é˜¶æ®µ 3: è°ƒåº¦å™¨ (Scheduler)

å½“å‰çš„ `sync_wait()` æ˜¯åŒæ­¥é˜»å¡çš„ï¼Œä¸é€‚åˆçœŸå®åœºæ™¯ã€‚éœ€è¦å®ç°ï¼š
- **WorkStealingScheduler**: å·¥ä½œçªƒå–è°ƒåº¦å™¨
- **çº¿ç¨‹æ± **: ç®¡ç†å·¥ä½œçº¿ç¨‹
- **ä»»åŠ¡é˜Ÿåˆ—**: å­˜å‚¨å¾…æ‰§è¡Œçš„åç¨‹

### é˜¶æ®µ 4: å¼‚æ­¥ I/O

- **EpollPoller**: Linux epoll äº‹ä»¶è½®è¯¢
- **AsyncFile**: å¼‚æ­¥æ–‡ä»¶æ“ä½œ
- **AsyncSocket**: å¼‚æ­¥ç½‘ç»œæ“ä½œ

---

## ğŸ“š å­¦ä¹ ç¬”è®°

### Generator çš„å…³é”®æ¦‚å¿µ

#### 1. **co_yield çš„å·¥ä½œåŸç†**
```cpp
Generator<int> example() {
    co_yield 42;  // 1. è°ƒç”¨ promise.yield_value(42)
                  // 2. å­˜å‚¨å€¼çš„åœ°å€åˆ° value_ptr_
                  // 3. è¿”å› suspend_alwaysï¼Œåç¨‹æŒ‚èµ·
}
```

#### 2. **æƒ°æ€§æ±‚å€¼çš„å®ç°**
- `initial_suspend()` è¿”å› `suspend_always`: åˆ›å»ºæ—¶ä¸æ‰§è¡Œ
- `begin()` è°ƒç”¨ `handle_.resume()`: å¼€å§‹æ‰§è¡Œåˆ°ç¬¬ä¸€ä¸ª yield
- `operator++()` è°ƒç”¨ `handle_.resume()`: ç»§ç»­æ‰§è¡Œåˆ°ä¸‹ä¸€ä¸ª yield

#### 3. **è¿­ä»£å™¨çš„å·¥ä½œæµç¨‹**
```cpp
for (int x : generator) {  // 1. è°ƒç”¨ generator.begin()
                            // 2. æ¢å¤åç¨‹ï¼Œæ‰§è¡Œåˆ°ç¬¬ä¸€ä¸ª co_yield
    // x æ˜¯å½“å‰ yield çš„å€¼  // 3. å¾ªç¯ä½“æ‰§è¡Œ
}                           // 4. operator++ï¼Œæ¢å¤åç¨‹åˆ°ä¸‹ä¸€ä¸ª yield
                            // 5. é‡å¤ç›´åˆ° operator== æ£€æµ‹åˆ°ç»“æŸ
```

---

Generator æ˜¯ä¸€ç§ç‰¹æ®Šçš„åç¨‹ï¼Œç”¨äºæƒ°æ€§ç”Ÿæˆåºåˆ—ï¼š

```cpp
Generator<int> range(int n) {
    for (int i = 0; i < n; ++i) {
        co_yield i;  // ç”Ÿæˆä¸€ä¸ªå€¼ï¼Œç„¶åæŒ‚èµ·
    }
}

// ä½¿ç”¨
for (int x : range(5)) {
    std::cout << x << "\n";  // è¾“å‡º 0 1 2 3 4
}
```

**éœ€è¦å®ç°**:
- `co_yield` æ”¯æŒ
- è¿­ä»£å™¨æ¥å£ (`begin()`, `end()`)
- æƒ°æ€§æ±‚å€¼ï¼ˆæŒ‰éœ€ç”Ÿæˆï¼‰

### é˜¶æ®µ 3: è°ƒåº¦å™¨ (Scheduler)

å½“å‰çš„ `sync_wait()` æ˜¯åŒæ­¥é˜»å¡çš„ï¼Œä¸é€‚åˆçœŸå®åœºæ™¯ã€‚éœ€è¦å®ç°ï¼š
- **WorkStealingScheduler**: å·¥ä½œçªƒå–è°ƒåº¦å™¨
- **çº¿ç¨‹æ± **: ç®¡ç†å·¥ä½œçº¿ç¨‹
- **ä»»åŠ¡é˜Ÿåˆ—**: å­˜å‚¨å¾…æ‰§è¡Œçš„åç¨‹

### é˜¶æ®µ 4: å¼‚æ­¥ I/O

- **EpollPoller**: Linux epoll äº‹ä»¶è½®è¯¢
- **AsyncFile**: å¼‚æ­¥æ–‡ä»¶æ“ä½œ
- **AsyncSocket**: å¼‚æ­¥ç½‘ç»œæ“ä½œ

---

## ğŸ’¡ æç¤º

**å½“å‰å·²å®ç°çš„åŠŸèƒ½**:
- âœ… Task<T>: å¼‚æ­¥ä»»åŠ¡ï¼Œæ”¯æŒ co_await é“¾å¼è°ƒç”¨
- âœ… Generator<T>: æƒ°æ€§åºåˆ—ç”Ÿæˆï¼Œæ”¯æŒ co_yield å’Œè¿­ä»£å™¨

**å°šæœªå®ç° (å•çº¿ç¨‹ç‰ˆæœ¬)**:
- âŒ ä¸æ”¯æŒå¤šçº¿ç¨‹è°ƒåº¦
- âŒ ä¸æ”¯æŒçœŸæ­£çš„å¼‚æ­¥ I/O
- âŒ æ²¡æœ‰äº‹ä»¶å¾ªç¯

è¿™äº›åŠŸèƒ½å°†åœ¨åç»­é˜¶æ®µå®ç°ï¼

---

## ğŸ“– å‚è€ƒèµ„æ–™

å¦‚æœæƒ³æ·±å…¥ç†è§£ï¼Œå¯ä»¥æŸ¥çœ‹ï¼š
- [C++20 åç¨‹ææ¡ˆ](https://en.cppreference.com/w/cpp/language/coroutines)
- [Lewis Baker çš„åç¨‹æ•™ç¨‹](https://lewissbaker.github.io/)
- `docs/ARCHITECTURE.md` - é¡¹ç›®æ¶æ„æ–‡æ¡£
- `docs/API.md` - API å‚è€ƒæ–‡æ¡£
