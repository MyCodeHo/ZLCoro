# 性能基准测试

本文档定义了 ZLCoro 组件的性能基准测试计划和测试方法。随着项目开发，测试结果将持续更新。

## 测试环境

测试将在以下环境进行：

- **CPU**: 待更新
- **内存**: 待更新
- **操作系统**: 待更新
- **编译器**: GCC/Clang with -O3 优化
- **内核**: 待更新

## 测试方法论

### 基准测试工具

- **Google Benchmark**: 用于微基准测试
- **自定义测试框架**: 用于集成测试
- **perf**: 用于 CPU 性能分析
- **valgrind**: 用于内存分析

### 测试流程

1. **预热期**: 10 秒
2. **测量期**: 60 秒
3. **重复次数**: 10 次运行
4. **结果统计**: 取中位数
5. **误差范围**: 记录 p50/p99 百分位

### 可重现性

所有基准测试可通过以下命令重现：

```bash
cd build
cmake -DCMAKE_BUILD_TYPE=Release ..
make benchmarks
./benchmarks/coroutine_bench
./benchmarks/scheduler_bench
./benchmarks/io_bench
```

## 协程原语测试

### Task 创建和销毁

测试目标：评估协程的创建、销毁和恢复开销。

| 操作 | 延迟 (ns) | 吞吐量 (ops/sec) | 测试状态 |
|-----------|--------------|----------------------|----------|
| Task 创建 | - | - | 待测试 |
| Task 销毁 | - | - | 待测试 |
| Task 带恢复 | - | - | 待测试 |

### 上下文切换性能

测试目标：评估协程切换的开销及嵌套性能。

| 场景 | 延迟 (ns) | 说明 | 测试状态 |
|----------|--------------|-------|----------|
| 简单挂起/恢复 | - | 单个协程 | 待测试 |
| 嵌套 co_await | - | 两层嵌套 | 待测试 |
| 深度嵌套 (10 层) | - | 线性开销 | 待测试 |

### 与其他方案对比

测试目标：与传统线程方案对比，验证协程优势。

| 方案 | 上下文切换延迟 (ns) | 创建开销 (ns) | 测试状态 |
|------|-------------------|--------------|----------|
| ZLCoro 协程 | - | - | 待测试 |
| pthread | ~1,500 | ~25,000 | 参考值 |
| std::thread | - | ~25,000 | 参考值 |

**预期性能目标**：
- 协程切换延迟 < 100 ns
- 比 pthread 快 10 倍以上
- 比线程创建快 100 倍以上

## 调度器性能测试

### 线程池调度器吞吐量

测试目标：评估不同工作线程数下的任务吞吐量和延迟。

| 工作线程数 | 任务/秒 | CPU 使用率 | 延迟 p50 (µs) | 延迟 p99 (µs) | 测试状态 |
|---------|-----------|-----------|--------------|--------------|----------|
| 1 | - | - | - | - | 待测试 |
| 2 | - | - | - | - | 待测试 |
| 4 | - | - | - | - | 待测试 |
| 8 | - | - | - | - | 待测试 |
| 16 | - | - | - | - | 待测试 |

**预期目标**：
- 单线程吞吐量 > 1M tasks/sec
- 多线程近似线性扩展
- p99 延迟 < 100 µs

### 工作窃取效率

测试目标：评估工作窃取机制的负载均衡效果。

| 场景 | 窃取率 (%) | 负载均衡得分 | 测试状态 |
|----------|------------|-------------------|----------|
| 均匀任务 | - | - | 待测试 |
| 倾斜任务 | - | - | 待测试 |
| 突发工作负载 | - | - | 待测试 |

**评估指标**：
- 窃取率：工作窃取发生的比例
- 负载均衡得分：0-1，越接近 1 表示负载越均衡

### I/O 调度器性能

测试目标：评估基于 Epoll 的 I/O 调度器性能。

#### Echo 服务器基准测试

| 连接数 | QPS | 延迟 p50 (µs) | 延迟 p99 (µs) | CPU 使用率 | 测试状态 |
|-------------|-----|------------------|------------------|-----------|----------|
| 100 | - | - | - | - | 待测试 |
| 1K | - | - | - | - | 待测试 |
| 10K | - | - | - | - | 待测试 |
| 100K | - | - | - | - | 待测试 |

**预期目标**：
- 10K 连接 QPS > 500K
- p99 延迟 < 2 ms
- CPU 使用率 < 90%

## 内存使用测试

### 每协程开销

测试目标：评估单个协程的内存占用。

| 组件 | 大小 (字节) | 测试状态 |
|-----------|--------------|----------|
| 协程帧 (最小) | - | 待测试 |
| Task<void> | - | 待测试 |
| Task<int> | - | 待测试 |
| Promise 开销 | - | 待测试 |

### 调度器内存

测试目标：评估调度器组件的内存占用。

| 组件 | 内存使用 | 可扩展性 | 测试状态 |
|-----------|--------------|-------------|----------|
| 线程池 (8 工作线程) | - | O(num_threads) | 待测试 |
| I/O 调度器 | - | O(1) 基础 | 待测试 |
| 定时器轮 | - | O(1) | 待测试 |
| 每连接状态 | - | O(connections) | 待测试 |

### 大规模内存测试

测试目标：评估百万级协程的内存扩展性。

| 并发协程数 | 内存 (GB) | 内存/协程 (KB) | 测试状态 |
|----------------------|-------------|----------------------|----------|
| 10K | - | - | 待测试 |
| 100K | - | - | 待测试 |
| 1M | - | - | 待测试 |
| 10M | - | - | 待测试 |

**预期目标**：
- 每协程内存 < 2 KB
- 内存/协程比例保持稳定

## 同步原语测试

### Mutex 性能

测试目标：评估协程 Mutex 在不同竞争场景下的性能。

| 场景 | 加锁/解锁 (ns) | 吞吐量 (ops/sec) | 测试状态 |
|----------|------------------|----------------------|----------|
| 无竞争 | - | - | 待测试 |
| 低竞争 (2 线程) | - | - | 待测试 |
| 中竞争 (4 线程) | - | - | 待测试 |
| 高竞争 (8 线程) | - | - | 待测试 |

### Channel 性能

测试目标：评估不同缓冲区大小下的 Channel 性能。

| 缓冲区大小 | 发送+接收 (ns) | 吞吐量 (msgs/sec) | 测试状态 |
|-------------|-------------------|----------------------|----------|
| 0 (无缓冲) | - | - | 待测试 |
| 10 | - | - | 待测试 |
| 100 | - | - | 待测试 |
| 1000 | - | - | 待测试 |

**预期目标**：
- 无缓冲 Channel > 1M msgs/sec
- 缓冲 Channel > 5M msgs/sec

## I/O 操作测试

### Socket 操作

测试目标：评估异步 Socket 的读写性能。

| 操作 | 延迟 (µs) | 吞吐量 | 测试状态 |
|-----------|--------------|------------|----------|
| async_read (1KB) | - | - | 待测试 |
| async_write (1KB) | - | - | 待测试 |
| async_read (64KB) | - | - | 待测试 |
| async_write (64KB) | - | - | 待测试 |

### 文件 I/O

测试目标：评估文件异步 I/O 性能（未来实现）。

| 操作 | 延迟 (µs) | 吞吐量 | 测试状态 |
|-----------|--------------|------------|----------|
| 异步读取 | - | - | 计划中 |
| 异步写入 | - | - | 计划中 |

## 实际应用基准测试

### HTTP 服务器

测试目标：评估实际 HTTP 服务器性能。

| 指标 | 值 | 测试条件 | 测试状态 |
|--------|-------|-----------------|----------|
| 请求/秒 | - | 1KB 静态文件 | 待测试 |
| 延迟 p50 | - | 1K 连接 | 待测试 |
| 延迟 p99 | - | 1K 连接 | 待测试 |
| 最大连接数 | - | 8GB 内存限制 | 待测试 |

**预期目标**：
- 请求/秒 > 100K
- p99 延迟 < 2 ms
- 最大连接数 > 50K

### JSON-RPC 服务器

测试目标：评估 RPC 服务器性能。

| 指标 | 值 | 测试条件 | 测试状态 |
|--------|-------|-----------------|----------|
| 请求/秒 | - | 简单方法调用 | 待测试 |
| 延迟 p50 | - | 1K 连接 | 待测试 |
| 延迟 p99 | - | 1K 连接 | 待测试 |

## 与业界框架对比

### vs. Go Goroutines

测试目标：与 Go 语言协程对比。

| 指标 | ZLCoro | Go 1.21+ | 对比 | 测试状态 |
|--------|--------|---------|-----------|----------|
| 创建时间 (ns) | - | ~2,500 | - | 待测试 |
| 上下文切换 (ns) | - | ~200 | - | 待测试 |
| 内存/协程 (KB) | - | ~2.0 | - | 待测试 |
| 最大并发数 | - | 10M+ | - | 待测试 |

### vs. Rust Tokio

测试目标：与 Rust 异步运行时对比。

| 指标 | ZLCoro | Tokio 1.32+ | 对比 | 测试状态 |
|--------|--------|------------|-----------|----------|
| 任务创建 (ns) | - | ~150 | - | 待测试 |
| Channel 发送 (ns) | - | ~95 | - | 待测试 |
| I/O 吞吐量 (QPS) | - | ~580K | - | 待测试 |

### vs. C++ 异步库

测试目标：与其他 C++ 异步框架对比。

| 框架 | 连接数 | QPS | 延迟 p99 (µs) | 测试状态 |
|-----------|-------------|-----|------------------|----------|
| ZLCoro | 10K | - | - | 待测试 |
| libuv | 10K | ~380K | ~1,800 | 参考值 |
| Boost.Asio | 10K | ~420K | ~1,500 | 参考值 |
| 原生 epoll | 10K | ~550K | ~1,100 | 参考值 |

## 优化效果测试

### 缓存优化

测试目标：评估缓存优化的效果。

| 优化项 | 优化前 (ns) | 优化后 (ns) | 提升 (%) | 测试状态 |
|--------------|-------------|------------|----------|----------|
| 数据对齐 | - | - | - | 待测试 |
| 缓存友好布局 | - | - | - | 待测试 |
| 移除伪共享 | - | - | - | 待测试 |

### 无锁算法

测试目标：评估无锁算法的性能提升。

| 组件 | 加锁版本 (ns) | 无锁版本 (ns) | 提升 (%) | 测试状态 |
|-----------|-------------|----------------|----------|----------|
| 工作队列 push | - | - | - | 待测试 |
| 工作队列 steal | - | - | - | 待测试 |

## 可扩展性分析

### CPU 扩展性

测试目标：评估多核扩展性能。

| 核心数 | 吞吐量 | 扩展效率 (%) | 测试状态 |
|--------|--------|------------|----------|
| 1 | - | 100% | 待测试 |
| 2 | - | - | 待测试 |
| 4 | - | - | 待测试 |
| 8 | - | - | 待测试 |
| 16 | - | - | 待测试 |

**分析重点**：
- 识别扩展瓶颈
- 评估是否存在内存带宽限制
- 检测缓存一致性开销
- NUMA 效应（多插槽系统）

### 内存扩展性

测试目标：评估内存使用的可预测性。

**关注指标**：
- 每协程内存开销的稳定性
- 内存池化效果
- 内存碎片情况
- GC-less 设计的优势

## 测试状态说明

| 状态 | 说明 |
|------|------|
| ✅ 已完成 | 测试已完成，数据已验证 |
| 🚧 进行中 | 正在进行测试 |
| 待测试 | 等待功能实现后测试 |
| 计划中 | 未来版本计划测试 |
| 参考值 | 业界参考数据，非实测 |

## 测试优先级

### P0 - 核心功能（v0.2.0）
- [ ] Task 创建/销毁性能
- [ ] 协程上下文切换
- [ ] 线程池调度器吞吐量
- [ ] 基本内存使用

### P1 - I/O 性能（v0.3.0）
- [ ] Echo 服务器基准测试
- [ ] Socket 读写性能
- [ ] I/O 调度器性能
- [ ] 大规模连接测试

### P2 - 同步原语（v0.4.0）
- [ ] Mutex 性能
- [ ] Channel 性能
- [ ] WaitGroup/Semaphore

### P3 - 优化验证（v0.5.0）
- [ ] 缓存优化效果
- [ ] 无锁算法性能
- [ ] CPU/内存扩展性

### P4 - 对比测试（v1.0.0）
- [ ] 与 Go/Rust 对比
- [ ] 与其他 C++ 库对比
- [ ] 实际应用场景测试

## 持续集成

所有基准测试将在 CI 中自动运行，监控性能回归：

- **触发条件**: 每次 PR 提交
- **回归检测**: 性能下降 > 5% 将触发警告
- **趋势分析**: 长期性能趋势可视化
- **报告生成**: 自动生成性能报告

---

**文档状态**: 测试计划中  
**最后更新**: 2025-11-07  
**下次更新**: 核心功能实现后

如有测试方法或指标建议，请在 GitHub Issues 中讨论。
